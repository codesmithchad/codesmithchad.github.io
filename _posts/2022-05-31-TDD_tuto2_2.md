---
layout: post
title: iOS Unit Testing and UI Testing Tutorial from raywenderlich.com PT.2
subtitle: raywenderlich.com을 참고하여 TDD를 학습해 본다.
# cover-img: /assets/img/toastMessageView.png
# thumbnail-img: /assets/img/thumb.png
# share-img: /assets/img/path.jpg
tags: [iOS, test, tdd, xctest, unit test, ui test]
---

## Faking Objects and Interactions

이제 `URLSession`을 통해 얻은 데이터도 정상 동작하는지 확인하고 싶다.\
대부분의 앱들이 컨트롤이 불가한 시스템이나 라이브러리 오브젝트와 상호작용한다.\
이것들과 상호작용하는 테스트는 느려지거나 반복적이지 않아 첫번째 원칙을 위반할 수 있다.\
대신 스텁이나 mock 오브젝트를 통해 가짜 인터렉션을 구성할 수 있다.\

시스템이 라이브러리 오브젝트에 의존성이 있다면 가짜를 사용하자.

### Faking Input From Stub
`getRandomNumber(completion:)`가 정확하게 다운로드한 데이터를 파싱하는지 확인하자.\
스텁 데이터로 가짜 `BullsEyeGame` 세션을 구성해 보자.\

테스트 페인으로 이동하여 +를 누르고 `New Unit Test Class`를 추가하고 `BullsEyeFakeTests`로 명명하고 `BullsEyeTests` 디렉토리에 저장하여 BullsEyeTests의 타겟으로 설정한다.\

마찬가지로 앱 모듈을 import 한다.

```swift
@testable import BullsEye
```

`BullsEyeFakeTests`애 `BullsEyeGame` 타입의 sut를 선언하고 setup과 teardown을 아래와 같이 설정한다.

```swift
var sut: BullsEyeGame!

override func setUpWithError() throws {
    try super.setUpWithError()
    sut = BullsEyeGame()
}

override func tearDownWithError() throws {
    sut = nil
    try super.tearDownWithError()
}
```

이 프로젝트의 서포팅 파일중에는 `URLSessionStub`을 포함하고 있다.\
`URLSessionProtocol`이라는 이름의 간단한 프로토콜이 data task를 만드는 메소드와 함께 정의되어 있다.\
또한 이 프로토콜을 따르는`URLSessionStub` 정의되어 있다.\
이니셜라이저가 데이터, reponse, 에러 데이터를 리턴하도록 정의되어 있다.\

이 fake를 설정하기 위해 `BullsEyeFakeTests`로 이동하여 아래의 테스트를 추가하자.

```swift
func testStartNewRoundUsesRandomValueFromApiRequest() {
    // given
    // 1
    let stubbedData = "[1]".data(using: .utf8)
    let urlString = "http://www.randomnumberapi.com/api/v1.0/random?min=0&max=100&count=1"
    let url = URL(string: urlString)!
    let stubbedResponse = HTTPURLResponse(url: url, statusCode: 200, httpVersion: nil, headerFields: nil)
    let urlSessionStub = URLSessionStub(data: stubbedData, response: stubbedResponse, error: nil)
    sut.urlSession = urlSessionStub
    let promise = expectation(description: "Value Received")
    
    // when
    sut.startNewRound {
        // then
        // 2
        XCTAssertEqual(self.sut.targetValue, 1)
        promise.fulfill()
    }
    wait(for: [promise], timeout: 5)
}
```

이 테스트는 두가지를 한다.
1. 가짜 데이터와 응답, 가짜 세션 오브젝트를 설정한고 가짜 세션을 sut에 에 주입한다.
2. 스텁이 가짜 비동기 메소드를 포함하고 있으므로 이번에도 비동기로 작성하여야 한다.\
startNewRound(completion:)를 호출하면 페이크 넘버와 targetValue가 비교하여 페이크 데이터를 맞게 파싱하는지 확인한다.


테스트를 실행하면 실제 네트웍이 아니기 때문에 빠르게 성공한다. 

### Faking an Update to Mock Object